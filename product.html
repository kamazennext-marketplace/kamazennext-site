<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Detail - Kama ZenNext</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="/assets/js/header.js" defer></script>
  <style>
    :root { --primary: #6366f1; --dark: #0f172a; --muted: #64748b; --border: #e2e8f0; --bg: #f8fafc; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--dark); }
    a { color: inherit; text-decoration: none; }
    main { max-width: 1100px; margin: 30px auto 120px; padding: 0 20px; }
    .hero { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06); }
    .title-row { display: flex; gap: 16px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .title-row h1 { margin: 0; font-size: 2rem; }
    .action-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 0.85rem; font-weight: 700; }
    .badge.cat { background: #eef2ff; color: #312e81; }
    .badge.api { background: #ecfeff; color: #155e75; }
    .badge.price { background: #fef3c7; color: #92400e; }
    .tagline { color: var(--muted); margin: 8px 0 12px; }
    .meta { color: var(--muted); display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-top: 14px; }
    .pill { background: #e2e8f0; color: #0f172a; padding: 8px 12px; border-radius: 999px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .section { margin-top: 28px; }
    .section h3 { margin-bottom: 12px; }
    ul { padding-left: 18px; margin: 0; color: var(--muted); line-height: 1.6; }
    .compare-btn { border: 1px solid var(--primary); color: var(--primary); background: #eef2ff; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .ghost-btn { border: 1px solid var(--border); background: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; color: var(--dark); }
    .pros-cons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }
    .pros-cons-grid h4 { margin: 0 0 8px; }
    .check-list { list-style: none; padding-left: 0; }
    .check-list li { margin-bottom: 8px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .check-list li::before { content: '\2713'; color: #16a34a; font-weight: 800; }
    .check-list.cons li::before { content: '\26A0'; color: #ea580c; }
    .pill-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .product-card { border: 1px solid var(--border); background: #fff; border-radius: 12px; padding: 14px; display: flex; gap: 12px; align-items: flex-start; transition: box-shadow 0.2s ease, transform 0.2s ease; }
    .product-card:hover { box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); transform: translateY(-2px); }
    .product-card img { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; }
    .product-card h4 { margin: 0 0 6px; font-size: 1rem; }
    .product-card p { margin: 0; color: var(--muted); font-size: 0.95rem; }
    .screenshot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .screenshot-grid img { width: 100%; border-radius: 12px; border: 1px solid var(--border); }
    .sticky-compare { position: fixed; right: 20px; bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, var(--primary), #a855f7); color: #fff; border-radius: 999px; font-weight: 800; box-shadow: 0 16px 40px rgba(99, 102, 241, 0.2); z-index: 30; display: inline-flex; align-items: center; gap: 10px; }
    .sticky-compare:hover { opacity: 0.95; }
    .small-meta { display: flex; gap: 6px; align-items: center; margin-top: 6px; color: var(--muted); font-size: 0.9rem; }
    .alt-section-header { display: flex; align-items: center; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
    .reviews-grid { display: grid; gap: 12px; }
    .review-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05); }
    .review-title { margin: 0 0 6px; font-size: 1rem; }
    .review-meta { color: var(--muted); font-size: 0.9rem; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 0.85rem; font-weight: 700; background: #eef2ff; color: #312e81; margin-right: 8px; margin-top: 6px; }
    .chip.con { background: #fef2f2; color: #991b1b; }
    @media (max-width: 640px) {
      nav { width: 100%; order: 3; }
      .sticky-compare { right: 12px; bottom: 12px; left: 12px; justify-content: center; }
    }
  </style>
  <script src="/assets/js/security.js"></script>
</head>
<body>
  <div id="site-header"></div>

  <main>
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <ol>
        <li><a href="/">Home</a></li>
        <li><a href="/software.html">Products</a></li>
        <li><a id="productCategoryLink" href="/software.html">Category</a></li>
        <li id="productCrumb" aria-current="page">Product</li>
      </ol>
    </nav>
    <div id="productCard" class="hero" aria-live="polite">Loading...</div>
  </main>

  <a class="sticky-compare" href="/compare.html"><i class="fa-solid fa-sliders"></i> Compare</a>

  <script type="module">
    import { injectBaseSchema, injectBreadcrumbs, setMeta } from '/assets/js/seo-schema.js';

    const params = new URLSearchParams(window.location.search);
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const pathProductId = pathParts[0] === 'p' ? decodeURIComponent(pathParts[1] || '') : '';
    const productId = pathProductId || params.get('id');
    const card = document.getElementById('productCard');
    const crumbCategoryLink = document.getElementById('productCategoryLink');
    const crumbProduct = document.getElementById('productCrumb');
    const origin = window.location.origin;

    injectBaseSchema({
      siteName: 'Kama ZenNext',
      siteUrl: origin,
      logoUrl: `${origin}/assets/favicon.svg`
    });

    const getCompareIds = () => {
      try { return JSON.parse(localStorage.getItem('kz_compare_ids')) || []; }
      catch { return []; }
    };
    const saveCompareIds = (ids) => localStorage.setItem('kz_compare_ids', JSON.stringify(ids.slice(0, 4)));
    const addToCompare = (id) => {
      const ids = getCompareIds();
      if (ids.includes(id)) return ids;
      if (ids.length >= 4) { alert('You can only compare up to 4 products.'); return ids; }
      ids.push(id); saveCompareIds(ids); return ids;
    };

    const slugify = (str) => (str || '').toString().toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');

    const deriveReviewStats = (product = {}) => {
      const reviews = Array.isArray(product.reviews) ? product.reviews : [];
      const derivedCount = reviews.length;
      const reviewCount = Number.isFinite(product.review_count) ? product.review_count : derivedCount;
      let rating = Number(product.rating);
      if ((!rating || rating <= 0) && derivedCount) {
        const sum = reviews.reduce((acc, r) => acc + (Number(r.rating) || 0), 0);
        rating = sum ? Math.round((sum / derivedCount) * 10) / 10 : undefined;
      }
      return { rating, reviewCount: reviewCount || derivedCount, reviews };
    };

    const buildStructuredData = (product, canonicalUrl) => {
      if (!product) return null;
      const data = {
        '@context': 'https://schema.org',
        '@type': 'SoftwareApplication',
        name: product.name,
        applicationCategory: `${product.category} software`,
        operatingSystem: (product.platforms || []).join(', ') || 'Web',
        url: product.website || canonicalUrl,
        dateModified: product.last_updated || new Date().toISOString().slice(0, 10)
      };
      if (product.pricing) {
        data.offers = {
          '@type': 'Offer',
          price: product.pricing.starting_price !== undefined ? product.pricing.starting_price : '',
          priceCurrency: 'USD',
          category: product.pricing.model
        };
      }
      const stats = deriveReviewStats(product);
      if (stats.reviewCount > 0 && stats.rating) {
        data.aggregateRating = {
          '@type': 'AggregateRating',
          ratingValue: stats.rating,
          reviewCount: stats.reviewCount
        };
      }
      return data;
    };

    const hydrateSEO = (product) => {
      if (!product) return;
      const canonicalUrl = `${origin}/p/${encodeURIComponent(product.id)}`;
      const title = `${product.name} | ${product.category} AI Tool | Kama ZenNext`;
      const description = (product.tagline || '').substring(0, 150);
      const categoryUrl = `${origin}/category/${slugify(product.category)}`;

      setMeta({
        title,
        description,
        canonicalUrl,
        ogTitle: title,
        ogDescription: description,
        ogUrl: canonicalUrl,
        ogType: 'product'
      });

      injectBreadcrumbs([
        { name: 'Home', url: `${origin}/` },
        { name: 'Products', url: `${origin}/software.html` },
        { name: product.category, url: categoryUrl },
        { name: product.name, url: canonicalUrl }
      ]);

      const ldData = buildStructuredData(product, canonicalUrl);
      if (ldData) {
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify(ldData);
        document.head.appendChild(script);
      }
    };

    const buildBadgeRow = (items = []) => items.map(item => `<span class="pill">${item}</span>`).join('');

    const randomSample = (arr, count) => {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, count);
    };

    const renderAlternatives = (product, list) => {
      const alternatives = (list || []).filter(item => item.category === product.category && item.id !== product.id).slice(0, 6);
      if (!alternatives.length) return '';
      return `
        <div class="section">
          <div class="alt-section-header">
            <h3>Alternatives</h3>
            <a class="ghost-btn" href="/category/${slugify(product.category)}">View all in category</a>
          </div>
          <div class="card-grid">
            ${alternatives.map(item => `
              <a class="product-card" href="/p/${encodeURIComponent(item.id)}">
                <img src="${item.logo}" alt="${item.name} logo" loading="lazy" />
                <div>
                  <h4>${item.name}</h4>
                  <p>${item.tagline || ''}</p>
                  <div class="small-meta">${item.rating ? `<span><i class='fa-solid fa-star' aria-hidden='true'></i> ${item.rating}</span>` : ''}</div>
                </div>
              </a>
            `).join('')}
          </div>
        </div>
      `;
    };

    const renderCompareSuggestions = (product, list) => {
      const compareIds = getCompareIds().filter(id => id !== product.id);
      const pool = (list || []).filter(item => item.id !== product.id);
      const comparePicks = compareIds.length ? pool.filter(item => compareIds.includes(item.id)) : [];
      const productsToShow = comparePicks.length
        ? comparePicks
        : randomSample(pool.filter(item => item.category === product.category), 4);

      if (!productsToShow.length) return '';
      return `
        <div class="section">
          <div class="alt-section-header">
            <h3>People also compare</h3>
            <a class="ghost-btn" href="/compare.html">Open compare</a>
          </div>
          <div class="card-grid">
            ${productsToShow.slice(0, 6).map(item => `
              <a class="product-card" href="/p/${encodeURIComponent(item.id)}">
                <img src="${item.logo}" alt="${item.name} logo" loading="lazy" />
                <div>
                  <h4>${item.name}</h4>
                  <p>${item.tagline || ''}</p>
                  <div class="small-meta">${item.category}</div>
                </div>
              </a>
            `).join('')}
          </div>
        </div>
      `;
    };

    const renderScreenshots = (product) => {
      if (!product.screenshots || !product.screenshots.length) return '';
      return `
        <div class="section">
          <h3>Screenshots</h3>
          <div class="screenshot-grid">
            ${product.screenshots.map((src, idx) => `<img src="${src}" alt="${product.name} screenshot ${idx + 1}" loading="lazy" />`).join('')}
          </div>
        </div>
      `;
    };

    const renderReviewBadges = (items = [], variant = '') => items.map(item => `<span class="chip ${variant}">${item}</span>`).join('');

    const renderReviews = (product) => {
      const { reviews, rating, reviewCount } = deriveReviewStats(product);
      if (!reviews.length) {
        return `
          <div class="section">
            <h3>Reviews</h3>
            <p class="tagline">No reviews yet. Curated reviews coming soon.</p>
          </div>`;
      }

      const sortedReviews = [...reviews].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).slice(0, 5);
      return `
        <div class="section">
          <div class="alt-section-header">
            <h3>Reviews</h3>
            <div class="small-meta">${rating ? `<strong><i class='fa-solid fa-star' aria-hidden='true'></i> ${rating} / 5</strong>` : ''} ${reviewCount ? `(${reviewCount} review${reviewCount === 1 ? '' : 's'})` : ''}</div>
          </div>
          <div class="reviews-grid">
            ${sortedReviews.map(review => `
              <article class="review-card">
                <div class="review-meta">
                  <strong>${review.author || 'Curator'}</strong>
                  ${review.rating ? `<span><i class='fa-solid fa-star' aria-hidden='true'></i> ${review.rating}/5</span>` : ''}
                  ${review.date ? `<time datetime="${review.date}">${review.date}</time>` : ''}
                </div>
                <h4 class="review-title">${review.title || ''}</h4>
                <p class="tagline">${review.body || ''}</p>
                <div>
                  ${renderReviewBadges(review.pros, '')}
                  ${renderReviewBadges(review.cons, 'con')}
                </div>
              </article>
            `).join('')}
          </div>
        </div>
      `;
    };

    const renderProduct = (product, list) => {
      if (!product) {
        card.innerHTML = `<p>Product not found. <a href="/software.html">Back to Products</a></p>`;
        crumbCategoryLink.textContent = 'Products';
        crumbCategoryLink.href = '/software.html';
        crumbProduct.textContent = 'Product';
        return;
      }

      hydrateSEO(product);
      const { rating, reviewCount } = deriveReviewStats(product);
      const compareIds = getCompareIds();
      const categoryLink = `/category/${slugify(product.category)}`;
      crumbCategoryLink.textContent = product.category;
      crumbCategoryLink.href = categoryLink;
      crumbProduct.textContent = product.name;

      const prosConsSection = (product.pros && product.pros.length) || (product.cons && product.cons.length)
        ? `
          <div class="section">
            <h3>Pros & Cons</h3>
            <div class="pros-cons-grid">
              ${product.pros && product.pros.length ? `<div><h4>Pros</h4><ul class="check-list">${product.pros.map(item => `<li>${item}</li>`).join('')}</ul></div>` : ''}
              ${product.cons && product.cons.length ? `<div><h4>Cons</h4><ul class="check-list cons">${product.cons.map(item => `<li>${item}</li>`).join('')}</ul></div>` : ''}
            </div>
          </div>`
        : '';

      const useCasesSection = product.use_cases && product.use_cases.length
        ? `
          <div class="section">
            <h3>Use cases</h3>
            <div class="pill-row">${buildBadgeRow(product.use_cases)}</div>
          </div>`
        : '';

      card.innerHTML = `
        <div class="title-row">
          <div>
            <a class="badge cat" href="${categoryLink}"><i class="fa-solid fa-tag"></i> ${product.category}</a>
            <h1>${product.name}</h1>
            <p class="tagline">${product.tagline || ''}</p>
            ${rating ? `<div class="small-meta"><i class='fa-solid fa-star' aria-hidden='true'></i> ${rating} â€¢ ${reviewCount || 0} review${(reviewCount || 0) === 1 ? '' : 's'}</div>` : ''}
          </div>
          <div class="action-row">
            <button class="ghost-btn" id="copyLinkBtn" type="button"><i class="fa-solid fa-link"></i> Copy link</button>
            <button class="compare-btn" id="compareBtn">${compareIds.includes(product.id) ? 'In Compare' : 'Add Compare'}</button>
          </div>
        </div>
        <div class="meta">
          <div><strong>Pricing:</strong> ${product.pricing ? product.pricing.model : 'N/A'} (${product.pricing && product.pricing.starting_price !== undefined ? '$' + product.pricing.starting_price : ''})</div>
          <div><strong>API:</strong> ${product.api ? 'Yes' : 'No'}</div>
          <div><strong>Platforms:</strong> ${product.platforms ? product.platforms.join(', ') : 'N/A'}</div>
          <div><strong>Last updated:</strong> ${product.last_updated || 'N/A'}</div>
        </div>
        <div class="section">
          <h3>Best for</h3>
          <div class="pill-row">${buildBadgeRow(product.best_for || [])}</div>
        </div>
        <div class="section">
          <h3>Key features</h3>
          <ul>${(product.key_features || []).map(f => `<li>${f}</li>`).join('')}</ul>
        </div>
        ${prosConsSection}
        ${useCasesSection}
        <div class="section">
          <h3>Integrations</h3>
          <p class="tagline">${(product.integrations || []).join(', ')}</p>
        </div>
        ${renderReviews(product)}
        ${renderScreenshots(product)}
        ${renderAlternatives(product, list)}
        ${renderCompareSuggestions(product, list)}
        <div class="section">
          <a class="cta" href="${product.website}" target="_blank" rel="noopener">Visit website</a>
        </div>
      `;

      const compareBtn = document.getElementById('compareBtn');
      compareBtn.addEventListener('click', () => {
        const ids = addToCompare(product.id);
        if (ids.includes(product.id)) compareBtn.textContent = 'In Compare';
      });

      const copyLinkBtn = document.getElementById('copyLinkBtn');
      copyLinkBtn.addEventListener('click', async () => {
        const shareUrl = `${origin}/p/${encodeURIComponent(product.id)}`;
        try {
          await navigator.clipboard.writeText(shareUrl);
          copyLinkBtn.textContent = 'Copied!';
          setTimeout(() => { copyLinkBtn.textContent = 'Copy link'; }, 1200);
        } catch (err) {
          console.error('Copy failed', err);
        }
      });
    };

    if (!productId) {
      renderProduct(null, []);
    } else {
      fetch('/data/products.json')
        .then(res => res.json())
        .then(list => renderProduct((list || []).find(p => p.id === productId), list || []))
        .catch(() => renderProduct(null, []));
    }
  </script>
</body>
</html>
